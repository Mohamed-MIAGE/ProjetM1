// Plug Grove - Relay to base shield port D2
// Plug Grove - Temperature&Huminity(High quality) to i2c port

var sensor1 = require('jsupm_th02');
var th02 = new sensor1.TH02();

var sensor2 = require('jsupm_grove');
var relay = new sensor2.GroveRelay(2);

// Simulate device value
var temp = 24.00;
var humi = 50;
var relayState = false;
var reported_state = {"Temperature":temp, "Humidity": humi, "RelayState": relayState};

//
// Client token value returned from thingShadows.update() operation//app deps
const thingShadow = require('./thing');// Plug Grove - Relay to base shield port D2
// Plug Grove - Temperature&Huminity(High quality) to i2c port

var sensor1 = require('jsupm_th02');
var th02 = new sensor1.TH02();

var sensor2 = require('jsupm_grove');
var relay = new sensor2.GroveRelay(2);

var awsIot = require('aws-iot-device-sdk');

var thingShadows = awsIot.thingShadow({
    keyPath: '/home/root/aws_certs/my_private_key.pem',
    certPath: '/home/root/aws_certs/my_certificate.pem',
    caPath: '/home/root/aws_certs/aws-iot-rootCA.crt',
    clientId: 'SioTeam_edison_id',
    region: 'us-west-2'
});

// Simulate device value
var temp = 24.00;
var humi = 50;
var relayState = false;

//
// Client token value returned from thingShadows.update() operation
//
var clientTokenUpdate;

var thingName = "SioT_Edison";
thingShadows.on('connect', function() {
    thingShadows.register(thingName);
    console.log(thingName + ' registering...');

    setInterval(function(){
      readSensor(sendData);
    }, 5000);
});

thingShadows.on('status', function(thingName, stat, clientToken, stateObject) {
    console.log('   received '+stat+' on '+thingName+': '+ JSON.stringify(stateObject));
    //
    // These events report the status of update(), get(), and delete()
    // calls.  The clientToken value associated with the event will have
    // the same value which was returned in an earlier call to get(),
    // update(), or delete().  Use status events to keep track of the
    // status of shadow operations.
    //
});

thingShadows.on('delta', function(thingName, stateObject) {
    console.log('    received delta on '+thingName+': '+ JSON.stringify(stateObject));

    if(stateObject.state.RelayState == true){
        relay.on();
        console.log('Relay is on.');
    }
    else if(stateObject.state.RelayState == false) {
        relay.off();
        console.log('Relay is off.');
    }
});

thingShadows.on('timeout', function(thingName, clientToken) {
    console.log('    received timeout on '+thingName + ' with token: '+ clientToken);
    //
    // In the event that a shadow operation times out, you'll receive
    // one of these events.  The clientToken value associated with the
    // event will have the same value which was returned in an earlier
    // call to get(), update(), or delete().
    //
});

function readSensor(callback){
    temp = th02.getTemperature();
    humi = th02.getHumidity();
    relayState = relay.isOn();

    callback();
};

function sendData(){
    var reported_state = {"Temperature":temp, "Humidity": humi, "RelayState": relayState};
    var relayTH02State = {"state":{desired: reported_state}};  // Use desired attribute can receive delta
    // More info refer to http://docs.aws.amazon.com/iot/latest/developerguide/thing-shadow-mqtt.html#update-pub-sub-message

    clientTokenUpdate = thingShadows.update(thingName, relayTH02State);

    if (clientTokenUpdate === null)
    {
       console.log('update shadow failed, operation still in progress');
    }
};